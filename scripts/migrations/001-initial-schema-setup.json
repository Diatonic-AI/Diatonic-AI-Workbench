{
  "name": "Initial Schema Setup for AI Nexus Workbench",
  "version": "1.0.0",
  "description": "Creates the foundational DynamoDB tables and indexes for the AI Nexus Workbench application",
  "author": "AI Nexus Development Team",
  "created": "2025-01-07T20:30:00Z",
  "estimatedDuration": "15-20 minutes",
  "targetEnvironment": "development",
  "backupRequired": false,
  "riskLevel": "medium",
  "rollbackProcedure": "Tables can be safely deleted as this is initial setup",
  "preHooks": [
    {
      "type": "mcpTool",
      "name": "validate-aws-credentials",
      "parameters": {
        "region": "us-east-2",
        "requiredPermissions": [
          "dynamodb:CreateTable",
          "dynamodb:DescribeTable",
          "dynamodb:PutItem"
        ]
      },
      "required": true
    }
  ],
  "operations": [
    {
      "type": "createTable",
      "description": "Create main entities table for storing AI agents, workflows, and projects",
      "estimatedTime": "5 minutes",
      "riskLevel": "low",
      "data": {
        "tableName": "ai-nexus-workbench-development-entities",
        "schema": {
          "attributes": [
            {
              "AttributeName": "PK",
              "AttributeType": "S"
            },
            {
              "AttributeName": "SK",
              "AttributeType": "S"
            },
            {
              "AttributeName": "GSI1PK",
              "AttributeType": "S"
            },
            {
              "AttributeName": "GSI1SK",
              "AttributeType": "S"
            },
            {
              "AttributeName": "entityType",
              "AttributeType": "S"
            },
            {
              "AttributeName": "userId",
              "AttributeType": "S"
            },
            {
              "AttributeName": "status",
              "AttributeType": "S"
            },
            {
              "AttributeName": "createdAt",
              "AttributeType": "N"
            }
          ],
          "keySchema": [
            {
              "AttributeName": "PK",
              "KeyType": "HASH"
            },
            {
              "AttributeName": "SK",
              "KeyType": "RANGE"
            }
          ],
          "globalSecondaryIndexes": [
            {
              "IndexName": "GSI1",
              "KeySchema": [
                {
                  "AttributeName": "GSI1PK",
                  "KeyType": "HASH"
                },
                {
                  "AttributeName": "GSI1SK",
                  "KeyType": "RANGE"
                }
              ],
              "Projection": {
                "ProjectionType": "ALL"
              },
              "BillingMode": "PAY_PER_REQUEST"
            },
            {
              "IndexName": "TypeIndex",
              "KeySchema": [
                {
                  "AttributeName": "entityType",
                  "KeyType": "HASH"
                },
                {
                  "AttributeName": "createdAt",
                  "KeyType": "RANGE"
                }
              ],
              "Projection": {
                "ProjectionType": "KEYS_ONLY"
              },
              "BillingMode": "PAY_PER_REQUEST"
            },
            {
              "IndexName": "UserIndex",
              "KeySchema": [
                {
                  "AttributeName": "userId",
                  "KeyType": "HASH"
                },
                {
                  "AttributeName": "status",
                  "KeyType": "RANGE"
                }
              ],
              "Projection": {
                "ProjectionType": "ALL"
              },
              "BillingMode": "PAY_PER_REQUEST"
            }
          ]
        },
        "billing": {
          "mode": "PAY_PER_REQUEST"
        },
        "enableStreams": true,
        "streamViewType": "NEW_AND_OLD_IMAGES",
        "tags": [
          {
            "Key": "Project",
            "Value": "ai-nexus-workbench"
          },
          {
            "Key": "Environment", 
            "Value": "development"
          },
          {
            "Key": "Purpose",
            "Value": "main-entity-storage"
          },
          {
            "Key": "CreatedBy",
            "Value": "migration-system"
          }
        ]
      }
    },
    {
      "type": "createTable",
      "description": "Create sessions table for tracking user sessions and activity",
      "estimatedTime": "3 minutes", 
      "riskLevel": "low",
      "data": {
        "tableName": "ai-nexus-workbench-development-sessions",
        "schema": {
          "attributes": [
            {
              "AttributeName": "sessionId",
              "AttributeType": "S"
            },
            {
              "AttributeName": "userId",
              "AttributeType": "S"
            },
            {
              "AttributeName": "expiresAt",
              "AttributeType": "N"
            }
          ],
          "keySchema": [
            {
              "AttributeName": "sessionId",
              "KeyType": "HASH"
            }
          ],
          "globalSecondaryIndexes": [
            {
              "IndexName": "UserSessionsIndex",
              "KeySchema": [
                {
                  "AttributeName": "userId",
                  "KeyType": "HASH"
                },
                {
                  "AttributeName": "expiresAt",
                  "KeyType": "RANGE"
                }
              ],
              "Projection": {
                "ProjectionType": "ALL"
              },
              "BillingMode": "PAY_PER_REQUEST"
            }
          ]
        },
        "billing": {
          "mode": "PAY_PER_REQUEST"
        },
        "tags": [
          {
            "Key": "Project",
            "Value": "ai-nexus-workbench"
          },
          {
            "Key": "Environment",
            "Value": "development"
          },
          {
            "Key": "Purpose", 
            "Value": "session-management"
          },
          {
            "Key": "TTL",
            "Value": "enabled"
          }
        ]
      }
    },
    {
      "type": "createTable",
      "description": "Create audit log table for compliance and debugging",
      "estimatedTime": "3 minutes",
      "riskLevel": "low", 
      "data": {
        "tableName": "ai-nexus-workbench-development-audit-logs",
        "schema": {
          "attributes": [
            {
              "AttributeName": "logId",
              "AttributeType": "S"
            },
            {
              "AttributeName": "timestamp",
              "AttributeType": "N"
            },
            {
              "AttributeName": "entityId",
              "AttributeType": "S"
            },
            {
              "AttributeName": "action",
              "AttributeType": "S"
            }
          ],
          "keySchema": [
            {
              "AttributeName": "logId",
              "KeyType": "HASH"
            },
            {
              "AttributeName": "timestamp",
              "KeyType": "RANGE"
            }
          ],
          "globalSecondaryIndexes": [
            {
              "IndexName": "EntityLogsIndex",
              "KeySchema": [
                {
                  "AttributeName": "entityId",
                  "KeyType": "HASH"
                },
                {
                  "AttributeName": "timestamp",
                  "KeyType": "RANGE"
                }
              ],
              "Projection": {
                "ProjectionType": "ALL"
              },
              "BillingMode": "PAY_PER_REQUEST"
            },
            {
              "IndexName": "ActionLogsIndex",
              "KeySchema": [
                {
                  "AttributeName": "action",
                  "KeyType": "HASH"
                },
                {
                  "AttributeName": "timestamp",
                  "KeyType": "RANGE"
                }
              ],
              "Projection": {
                "ProjectionType": "INCLUDE",
                "NonKeyAttributes": ["logId", "entityId", "userId", "details"]
              },
              "BillingMode": "PAY_PER_REQUEST"
            }
          ]
        },
        "billing": {
          "mode": "PAY_PER_REQUEST"
        },
        "enableStreams": false,
        "tags": [
          {
            "Key": "Project",
            "Value": "ai-nexus-workbench"
          },
          {
            "Key": "Environment",
            "Value": "development"
          },
          {
            "Key": "Purpose",
            "Value": "audit-compliance"
          },
          {
            "Key": "DataRetention",
            "Value": "7years"
          }
        ]
      }
    },
    {
      "type": "mcpToolChain",
      "description": "Use MCP tools to validate schema and generate documentation",
      "estimatedTime": "2 minutes",
      "riskLevel": "low",
      "required": false,
      "data": {
        "toolChain": [
          {
            "name": "schema-validator",
            "parameters": {
              "schemaType": "dynamodb",
              "tables": [
                "ai-nexus-workbench-development-entities",
                "ai-nexus-workbench-development-sessions", 
                "ai-nexus-workbench-development-audit-logs"
              ]
            },
            "outputVariable": "validationResults",
            "required": false
          },
          {
            "name": "documentation-generator",
            "parameters": {
              "sourceSchema": "{{validationResults}}",
              "outputFormat": "markdown",
              "includeIndexes": true
            },
            "outputVariable": "documentation",
            "required": false
          }
        ],
        "variables": {
          "environment": "development",
          "project": "ai-nexus-workbench"
        }
      }
    },
    {
      "type": "seedData",
      "description": "Insert initial configuration and default data",
      "estimatedTime": "2 minutes",
      "riskLevel": "low",
      "data": {
        "tableName": "ai-nexus-workbench-development-entities",
        "items": [
          {
            "PK": "CONFIG#SYSTEM",
            "SK": "VERSION",
            "GSI1PK": "CONFIG",
            "GSI1SK": "SYSTEM#VERSION",
            "entityType": "configuration",
            "configType": "system",
            "version": "1.0.0",
            "schemaVersion": "1.0.0",
            "migrationVersion": "1.0.0",
            "createdAt": 1704657000000,
            "updatedAt": 1704657000000,
            "data": {
              "features": {
                "agentBuilder": true,
                "workflowEngine": true,
                "integrations": true,
                "analytics": false
              },
              "limits": {
                "maxAgentsPerUser": 50,
                "maxWorkflowsPerUser": 100,
                "maxExecutionsPerDay": 1000
              }
            }
          },
          {
            "PK": "CONFIG#DEFAULT",
            "SK": "AGENT_TEMPLATE",
            "GSI1PK": "CONFIG",
            "GSI1SK": "DEFAULT#AGENT_TEMPLATE",
            "entityType": "configuration",
            "configType": "template",
            "name": "Default Agent Template",
            "createdAt": 1704657000000,
            "updatedAt": 1704657000000,
            "data": {
              "name": "New Agent",
              "description": "A new AI agent",
              "type": "conversational",
              "model": "gpt-4",
              "parameters": {
                "temperature": 0.7,
                "maxTokens": 2000,
                "topP": 1.0
              },
              "tools": [],
              "memory": {
                "type": "conversation",
                "maxHistory": 10
              }
            }
          }
        ],
        "batchSize": 25
      }
    },
    {
      "type": "addTags",
      "description": "Add comprehensive tags to all created resources",
      "estimatedTime": "1 minute",
      "riskLevel": "low",
      "data": {
        "tables": [
          "ai-nexus-workbench-development-entities",
          "ai-nexus-workbench-development-sessions",
          "ai-nexus-workbench-development-audit-logs"
        ],
        "tags": [
          {
            "Key": "MigrationId",
            "Value": "001-initial-schema-setup"
          },
          {
            "Key": "CreatedDate",
            "Value": "2025-01-07"
          },
          {
            "Key": "Owner",
            "Value": "ai-nexus-team"
          },
          {
            "Key": "CostCenter",
            "Value": "development"
          },
          {
            "Key": "AutoShutdown",
            "Value": "false"
          }
        ]
      }
    }
  ],
  "postHooks": [
    {
      "type": "mcpTool",
      "name": "notify-team",
      "parameters": {
        "message": "Initial schema migration completed successfully",
        "environment": "development",
        "tables": [
          "ai-nexus-workbench-development-entities",
          "ai-nexus-workbench-development-sessions",
          "ai-nexus-workbench-development-audit-logs"
        ]
      },
      "required": false
    },
    {
      "type": "customScript",
      "name": "update-environment-config",
      "script": "updateEnvironmentConfig",
      "parameters": {
        "configFile": "../config/development.json",
        "updates": {
          "database.dynamodb.tables": {
            "entities": "ai-nexus-workbench-development-entities",
            "sessions": "ai-nexus-workbench-development-sessions",
            "auditLogs": "ai-nexus-workbench-development-audit-logs"
          },
          "database.dynamodb.region": "us-east-2"
        }
      },
      "required": false
    }
  ],
  "validation": {
    "requiredTables": [
      "ai-nexus-workbench-development-entities",
      "ai-nexus-workbench-development-sessions", 
      "ai-nexus-workbench-development-audit-logs"
    ],
    "requiredIndexes": [
      "GSI1",
      "TypeIndex", 
      "UserIndex",
      "UserSessionsIndex",
      "EntityLogsIndex",
      "ActionLogsIndex"
    ],
    "expectedRecordCount": {
      "ai-nexus-workbench-development-entities": 2
    }
  },
  "monitoring": {
    "healthChecks": [
      {
        "type": "tableExists",
        "tables": [
          "ai-nexus-workbench-development-entities",
          "ai-nexus-workbench-development-sessions",
          "ai-nexus-workbench-development-audit-logs"
        ]
      },
      {
        "type": "indexExists",
        "table": "ai-nexus-workbench-development-entities",
        "indexes": ["GSI1", "TypeIndex", "UserIndex"]
      },
      {
        "type": "dataExists",
        "table": "ai-nexus-workbench-development-entities",
        "key": { "PK": "CONFIG#SYSTEM", "SK": "VERSION" }
      }
    ],
    "alerts": [
      {
        "condition": "migration_duration > 30 minutes",
        "severity": "warning",
        "action": "notify_team"
      },
      {
        "condition": "any_operation_failed",
        "severity": "error", 
        "action": "rollback_and_notify"
      }
    ]
  },
  "metadata": {
    "dependencies": [],
    "impacts": [
      "Creates foundational data layer",
      "Enables user authentication flow",
      "Establishes audit trail system"
    ],
    "rollbackInstructions": [
      "Delete all created tables in reverse order",
      "Verify no residual data remains",
      "Update environment configuration to remove table references"
    ],
    "testingNotes": [
      "Verify all indexes are ACTIVE before proceeding",
      "Test basic CRUD operations on each table",
      "Confirm TTL configuration on sessions table",
      "Validate audit log capture functionality"
    ]
  }
}
